---
export const prerender = false;
import Layout from '@/layouts/Layout.astro';
import Banner from '@/components/details/banner.astro';
import ChatWithUS from '@/components/faqs/chatWithUS.astro';
import { getProductByHandle, getProductRecommendations } from "@/utils/shopify";
import AboutSection from '@/components/details/aboutSection.jsx';
import AboutSectionMobile from '@/components/details/aboutSectionMobile.jsx';
const { detail } = Astro.params;
import '@/components/details/information.css';

// Obtener IP del cliente de forma segura
let ip = null;
try {
    const headers = Astro.request.headers;
    ip = headers.get("x-vercel-forwarded-for") || headers.get("x-forwarded-for") || Astro.clientAddress;
} catch (error) {
    ip = null;
}

const product = await getProductByHandle({ handle: detail!, buyerIP: ip || "127.0.0.1" });
if (!product) {
    return Astro.redirect('/404');
}

const recommendations = await getProductRecommendations({ productId: product.id, buyerIP: ip || "127.0.0.1" });

let productFAQs: any[] = [];
if ((product.faq_s as any)?.faqs && (product.faq_s as any).faqs.length > 0) {
  const { processFAQsWithContent } = await import("@/utils/shopify");
  productFAQs = await processFAQsWithContent((product.faq_s as any).faqs, ip || "127.0.0.1");
}
---

<Layout>
    <Banner product={product} recommendations={recommendations} />
    <div class="w-full h-full sm:block hidden">
        <AboutSection product={product} faqs={productFAQs as any} client:load />
    </div>
    <div class="w-full h-full sm:hidden block">
        <AboutSectionMobile product={product} client:load />
    </div>
    <ChatWithUS />
</Layout>
