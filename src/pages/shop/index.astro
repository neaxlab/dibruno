---
import Layout from '@/layouts/Layout.astro';
import Banner from '@/components/shop/banner.astro';
import Categories from '@/components/shop/categories.astro';
import Products from '@/components/shop/products.astro';
import { getProductsPaginated, getProductsByHandle, getCollections } from "@/utils/shopify";
import { getCurrentCanonicalUrl } from '@/utils/seo';
export const prerender = false;

// Obtener IP del cliente de forma segura
let ip = null;
try {
    const headers = Astro.request.headers;
    ip = headers.get("x-vercel-forwarded-for") || headers.get("x-forwarded-for") || Astro.clientAddress;
} catch (error) {
    ip = null;
}

// Obtener parámetros de URL
const url = new URL(Astro.request.url);
const selectedCategory = url.searchParams.get('category') || 'all';

const limit = 20;
const after = null;

// Obtener todas las colecciones para validar la categoría seleccionada
const collections = await getCollections({ buyerIP: ip || "127.0.0.1" });
const validCategory = collections.find(col => col.handle === selectedCategory)?.handle || 'all';

// Obtener productos según la categoría seleccionada
const products = await getProductsByHandle({ 
    collectionHandle: validCategory, 
    buyerIP: ip || "127.0.0.1",
    limit 
});

const canonicalUrl = getCurrentCanonicalUrl(Astro.url.pathname);
---

<Layout canonicalUrl={canonicalUrl}>
    <Banner />
    <Categories ip={ip} collections={collections} selectedCategory={validCategory} />
    <Products products={products} />
</Layout>
